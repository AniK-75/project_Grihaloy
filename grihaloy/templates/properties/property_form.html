{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-xl-9 col-lg-10">
    <div class="card border-0 shadow-sm form-card">
      <div class="card-body p-4 p-md-5">
        <h3 class="mb-4 text-brown">
          {% if is_create %}Add Property{% else %}Edit Property{% endif %}
        </h3>

        {% if form.non_field_errors %}
          <div class="alert alert-warning">{{ form.non_field_errors }}</div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" id="property-form">
          {% csrf_token %}

          <div class="mb-3">
            <label class="form-label" for="{{ form.title.id_for_label }}">Title</label>
            {{ form.title }}
            {% for e in form.title.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
          </div>

          <div class="mb-4">
            <label class="form-label" for="{{ form.description.id_for_label }}">Description</label>
            {{ form.description }}
            {% for e in form.description.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
          </div>

          <div class="row g-3 mb-4">
            <div class="col-md-5">
              <label class="form-label" for="{{ form.address.id_for_label }}">Address</label>
              {{ form.address }}
              {% for e in form.address.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
            <div class="col-md-4">
              <label class="form-label" for="{{ form.area.id_for_label }}">Area</label>
              {{ form.area }}
              {% for e in form.area.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
            <div class="col-md-3">
              <label class="form-label" for="{{ form.city.id_for_label }}">City</label>
              {{ form.city }}
              {% for e in form.city.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
          </div>

          <div class="row g-3 mb-2">
            <div class="col-lg-3 col-md-4">
              <label class="form-label" for="{{ form.property_type.id_for_label }}">Type</label>
              {{ form.property_type }}
              {% for e in form.property_type.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
            <div class="col-lg-2 col-md-4">
              <label class="form-label" for="{{ form.bedrooms.id_for_label }}">Bedrooms</label>
              {{ form.bedrooms }}
              {% for e in form.bedrooms.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
            <div class="col-lg-2 col-md-4">
              <label class="form-label" for="{{ form.bathrooms.id_for_label }}">Bathrooms</label>
              {{ form.bathrooms }}
              {% for e in form.bathrooms.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
            <div class="col-lg-2 col-md-6">
              <label class="form-label" for="{{ form.size_sqft.id_for_label }}">Size (sqft)</label>
              {{ form.size_sqft }}
              {% for e in form.size_sqft.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
            <div class="col-lg-3 col-md-6">
              <label class="form-label" for="{{ form.price.id_for_label }}">Price</label>
              {{ form.price }}
              {% for e in form.price.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
          </div>

          <div class="row g-3 mb-4">
            <div class="col-md-4 d-flex align-items-center"> <div class="form-check">
                {{ form.is_price_fixed }}
                <label class="form-check-label ms-2" for="{{ form.is_price_fixed.id_for_label }}">Is price fixed?</label>
              </div>
            </div>
            <div class="col-md-4 d-flex align-items-center"> <div class="form-check">
                {{ form.is_active }}
                <label class="form-check-label ms-2" for="{{ form.is_active.id_for_label }}">Is active?</label>
              </div>
            </div>
            <div class="col-md-4 d-flex align-items-center">
              <div class="form-check">
                {{ form.negotiable }}
                <label class="form-check-label ms-2" for="{{ form.negotiable.id_for_label }}">Allow negotiation?</label>
              </div>
            </div>
            </div>

          <div class="mb-2">
            <label class="form-label">Property Photos</label>
            <label for="id_images" class="file-input-wrapper">
              <span class="file-input-text">Choose photos...</span>
              <span class="file-input-button">Choose File</span>
            </label>
            <input type="file" name="images" id="id_images" multiple accept="image/*" class="d-none">

            {% if photo_error %}
              <div class="text-danger small mt-2">{{ photo_error }}</div>
            {% endif %}
            <div class="form-text">At least one photo is required when creating a listing.</div>
          </div>

          <div class="mt-4 d-flex gap-2">
            <button type="submit" class="btn btn-brown">Save</button>
            {% if is_create %}
              <a href="{% url 'properties:list' %}" class="btn btn-outline-secondary">Cancel</a>
            {% else %}
              <a href="{% url 'properties:my' %}" class="btn btn-outline-secondary">Cancel</a>
            {% endif %}
          </div>
        </form>
        {% if not is_create and photos %}
          <hr class="my-4">
          <h5 class="text-brown mb-3">Existing Photos</h5>
          <div class="row g-3">
            {% for ph in photos %}
              <div class="col-6 col-md-4 col-lg-3">
                <div class="card border-0 shadow-sm h-100">
                  <img src="{{ ph.image.url }}" alt="Photo" class="card-img-top" style="height:160px; object-fit:cover;">
                  <div class="card-body p-2">

                    <a href="{% url 'properties:photo_delete' object.pk ph.pk %}"
                       class="btn btn-sm btn-outline-danger w-100 btn-delete-photo"
                       data-csrf="{{ csrf_token }}">
                       Delete
                    </a>
                    </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}

      </div>
    </div>
  </div>
</div>

<style>
  .form-card {
    border-radius: 12px;
    /* Reverted back to your light card style */
    background-color: white !important;
    border: 1px solid #dee2e6 !important;
  }

  /* --- REVERTED to your original light input field styles --- */
  .form-card .form-control,
  .form-card .form-select,
  .form-card textarea.form-control,
  .form-card select {
    height: 46px;
    background: #f7f7fb;
    border: 1px solid #e8e8ef;
    border-radius: 8px;
    transition: border-color .2s, box-shadow .2s, background-color .2s;
    color: #212529; /* Standard dark text color */
  }
  .form-card textarea.form-control {
    height: auto;
    min-height: 140px;
    resize: vertical;
  }
  .form-card .form-control:focus,
  .form-card .form-select:focus,
  .form-card textarea.form-control:focus,
  .form-card select:focus {
    background: #fff;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 4px rgba(199, 156, 109, 0.18);
    outline: none;
  }
  /* --- END OF REVERT --- */

  /* --- KEPT the fix for the dropdown option color --- */
  .form-card select option:hover {
    background-color: #0d6efd; /* Consistent blue */
    color: white;
  }

  .form-check-input {
    accent-color: var(--brown);
    border-color: var(--brown);
    cursor: pointer;
  }

  /* --- REVERTED Custom File Input Styles to light theme --- */
  .file-input-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    height: 46px; /* Match other inputs */
    padding: 0;
    border: 1px solid #e8e8ef;
    border-radius: 8px;
    background-color: #f7f7fb;
    cursor: pointer;
    transition: border-color 0.2s, box-shadow 0.2s;
    overflow: hidden;
  }
  .file-input-wrapper:hover {
    border-color: var(--accent-color);
  }
  .file-input-text {
    padding-left: 1rem;
    color: #6c757d;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .file-input-button {
    background-color: var(--brown-dark);
    color: white;
    font-weight: 500;
    padding: 0 1rem;
    height: 100%;
    display: flex;
    align-items: center;
    transition: background-color 0.2s, color 0.2s;
    flex-shrink: 0;
  }
  .file-input-wrapper:hover .file-input-button {
    background-color: var(--accent-color);
    color: var(--brown-dark);
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // --- This is your existing script for the file input, it is correct ---
    const propertyPhotosInput = document.querySelector('#id_images');
    const textSpan = document.querySelector('.file-input-text');

    if (propertyPhotosInput && textSpan) {
      propertyPhotosInput.addEventListener('change', function() {
        if (this.files.length > 0) {
          if (this.files.length === 1) {
            textSpan.textContent = this.files[0].name;
          } else {
            textSpan.textContent = `${this.files.length} files selected`;
          }
        } else {
          textSpan.textContent = 'Choose photos...';
        }
      });
    }

    // --- START FIX: JavaScript to handle photo deletion ---
    document.querySelectorAll('.btn-delete-photo').forEach(button => {
      button.addEventListener('click', function(e) {
        // Stop the link from navigating immediately
        e.preventDefault();

        if (confirm('Delete this photo?')) {
          // Create a new, temporary form
          const form = document.createElement('form');
          form.method = 'post';
          form.action = this.href; // 'this' is the <a> tag that was clicked

          // Create and add the CSRF token
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrfmiddlewaretoken';
          csrfInput.value = this.dataset.csrf; // Get token from data-csrf attribute
          form.appendChild(csrfInput);

          // Add the form to the page, submit it, then remove it
          document.body.appendChild(form);
          form.submit();
          document.body.removeChild(form);
        }
      });
    });
    // --- END FIX ---
  });
</script>
{% endblock %}