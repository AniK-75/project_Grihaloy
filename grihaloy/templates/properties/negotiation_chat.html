{% extends "base.html" %}
{% block content %}<style>
  /* Custom styles for chat */
  .chat-box {
    height: 60vh; /* Adjust as needed */
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    background-color: var(--cream);
    display: flex;
    flex-direction: column;
  }
  .message-bubble {
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    margin-bottom: 0.5rem;
    max-width: 80%;
    word-wrap: break-word;
    font-size: 0.95rem;
    line-height: 1.4;
    position: relative; /* For dropdown */
  }
  .message-mine {
    background-color: var(--accent-color);
    color: var(--brown-dark); /* Darker text for accent background */
    align-self: flex-end;
  }
  .message-other {
    background-color: #f0f0f0; /* Lighter background for other user */
    color: #333;
    align-self: flex-start;
  }
  .message-timestamp {
    font-size: 0.75rem;
    color: #888;
    margin-top: 0.25rem;
    text-align: right;
  }
  .message-other .message-timestamp {
    text-align: left;
  }
  .chat-input-area {
    margin-top: 1rem;
    display: flex;
    gap: 0.5rem;
  }
  .chat-input-area textarea {
    flex-grow: 1;
    border-radius: 0.5rem;
    border: 1px solid #dee2e6;
    padding: 0.75rem;
    resize: none;
    font-family: 'Poppins', sans-serif;
  }
  .chat-input-area button {
    padding: 0.75rem 1.5rem;
  }
  .chat-header {
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #eee;
  }
  .chat-header h4 {
    color: var(--brown);
  }

  /* --- NEW STYLES FOR EDIT/DELETE --- */
  .message-content {
    white-space: pre-wrap; /* Respects newlines */
  }
  .message-deleted {
    font-style: italic;
    color: #888;
  }
  .message-mine .message-deleted {
    color: var(--brown-dark);
    opacity: 0.8;
  }
  .timestamp-edited {
    font-style: italic;
    font-size: 0.7rem;
    color: #777;
  }
  .message-mine .timestamp-edited {
    color: var(--brown-dark);
    opacity: 0.8;
  }
  .message-actions {
    position: absolute;
    top: 2px;
    right: 5px;
  }
  .message-other .message-actions {
    left: 5px;
    right: auto;
  }
  .message-actions .dropdown-toggle::after {
    display: none; /* Hide default caret */
  }
  .message-actions .btn-sm {
    padding: 0.1rem 0.3rem;
    font-size: 0.7rem;
    line-height: 1;
    background: transparent;
    border: none;
    color: #888;
  }
  .message-mine .message-actions .btn-sm {
    color: var(--brown-dark);
    opacity: 0.7;
  }
  .message-actions .dropdown-menu {
    font-size: 0.85rem;
    min-width: auto;
  }
  .message-actions .dropdown-item {
    cursor: pointer;
  }
  /* --- END NEW STYLES --- */

</style>

<div class="chat-header d-flex justify-content-between align-items-center">
  <h4>Negotiation for <a href="{% url 'properties:detail' negotiation.property.pk %}" class="text-decoration-none text-brown">{{ negotiation.property.title }}</a></h4>
  <a href="{% url 'properties:my_negotiations' %}" class="btn btn-outline-secondary">Back to Negotiations</a>
</div>

<div class="card shadow-sm border-0">
  <div class="card-body">
    <div id="chat-messages" class="chat-box">

      {% for msg in messages %}
        <div
          class="message-bubble {% if msg.sender == current_user %}message-mine{% else %}message-other{% endif %}"
          data-message-id="{{ msg.pk }}"
        >
          {% if msg.is_deleted %}
            <div class="message-content message-deleted">[Message deleted]</div>
          {% else %}
            <div class="message-content">{{ msg.content|linebreaksbr }}</div>
            <div class="message-timestamp">
              {{ msg.timestamp|date:"M d, H:i" }}
              {% if msg.is_edited %}
                <span class="timestamp-edited">(edited {{ msg.updated_at|date:"M d, H:i" }})</span>
              {% endif %}
            </div>

            {% if msg.sender == current_user %}
            <div class="message-actions dropdown">
              <button class="btn btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                &#8942; </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item chat-action-edit" data-id="{{ msg.pk }}">Edit</a></li>
                <li><a class="dropdown-item chat-action-delete" data-id="{{ msg.pk }}">Delete</a></li>
              </ul>
            </div>
            {% endif %}
          {% endif %}
        </div>
      {% endfor %}
      </div>

    <div class="chat-input-area">
      <textarea id="chat-message-input" rows="3" placeholder="Type your message here..."></textarea>
      <button id="chat-message-submit" class="btn btn-accent">Send
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-send-fill" viewBox="0 0 16 16">
          <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.462.22c.075.034.18.064.293.089a.78.78 0 0 0.297.054L1.97 9.873A.75.75 0 0 0 2 10a.5.5 0 0 0 .5-.5V8.5a.5.5 0 0 0-1 0v.75a.75.75 0 0 0 1.5 0v-1.793l.354-.354L13.146 1.707a.5.5 0 0 0-.708-.708L1.137 13.963a.5.5 0 0 0 .65.65L15.233 10.145H15.234l.452-.18a.5.5 0 0 0 .082-.887l-.462-.22a.75.75 0 0 0-.293-.089.78.78 0 0 0-.297-.054L14.03 6.127A.75.75 0 0 0 14 6a.5.5 0 0 0-.5.5v1.75a.5.5 0 0 0 1 0v-.75a.75.75 0 0 0-1.5 0z"/>
        </svg>
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const chatBox = document.getElementById('chat-messages');
    chatBox.scrollTop = chatBox.scrollHeight; // Scroll to bottom on load

    const negotiationId = "{{ negotiation.pk }}";
    const userId = "{{ current_user.pk }}";
    const userName = "{{ current_user.username }}";
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/negotiation/' + negotiationId + '/'
    );

    // --- MODIFIED: onmessage handler to route commands ---
    chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      console.log("Received data:", data);

      if (data.error) {
        console.error("Chat Error:", data.error);
        alert("Error: " + data.error);
        return;
      }

      const command = data.command;

      if (command === 'new_message') {
        handleNewMessage(data);
      } else if (command === 'edit_message') {
        handleEditMessage(data);
      } else if (command === 'delete_message') {
        handleDeleteMessage(data);
      }
    };

    // --- NEW: Function to handle NEW messages ---
    function handleNewMessage(data) {
      const isMyMessage = data.sender_id === userId;

      const messageBubble = document.createElement('div');
      messageBubble.classList.add('message-bubble');
      messageBubble.classList.add(isMyMessage ? 'message-mine' : 'message-other');
      messageBubble.setAttribute('data-message-id', data.message_id);

      // Sanitize content
      const contentDiv = document.createElement('div');
      contentDiv.classList.add('message-content');
      contentDiv.innerText = data.message;

      const timestampDiv = document.createElement('div');
      timestampDiv.classList.add('message-timestamp');
      timestampDiv.innerText = data.timestamp;

      messageBubble.appendChild(contentDiv);
      messageBubble.appendChild(timestampDiv);

      // Add actions dropdown if it's my message
      if (isMyMessage) {
        const actionsDiv = document.createElement('div');
        actionsDiv.classList.add('message-actions', 'dropdown');
        actionsDiv.innerHTML = `
          <button class="btn btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">&#8942;</button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item chat-action-edit" data-id="${data.message_id}">Edit</a></li>
            <li><a class="dropdown-item chat-action-delete" data-id="${data.message_id}">Delete</a></li>
          </ul>
        `;
        messageBubble.appendChild(actionsDiv);
      }

      chatBox.appendChild(messageBubble);
      chatBox.scrollTop = chatBox.scrollHeight; // Scroll to new message
    }

    // --- NEW: Function to handle EDITED messages ---
    function handleEditMessage(data) {
      const messageBubble = document.querySelector(`.message-bubble[data-message-id="${data.message_id}"]`);
      if (messageBubble) {
        const contentDiv = messageBubble.querySelector('.message-content');
        const timestampDiv = messageBubble.querySelector('.message-timestamp');

        contentDiv.innerText = data.new_content; // Update content

        // Update timestamp with "(edited)"
        const editedSpan = timestampDiv.querySelector('.timestamp-edited') || document.createElement('span');
        editedSpan.classList.add('timestamp-edited');
        editedSpan.innerText = ` (edited ${data.timestamp})`;
        timestampDiv.appendChild(editedSpan);
      }
    }

    // --- START MODIFIED 'handleDeleteMessage' FUNCTION ---
    function handleDeleteMessage(data) {
      const messageBubble = document.querySelector(`.message-bubble[data-message-id="${data.message_id}"]`);
      if (messageBubble) {
        // FIX: Replace the content but keep the alignment ('message-mine'/'message-other')
        messageBubble.innerHTML = `<div class="message-content message-deleted">[Message deleted]</div>`;

        // We no longer need to remove classes, just the content.
        // The original alignment class (message-mine or message-other) remains.
      }
    }
    // --- END MODIFIED 'handleDeleteMessage' FUNCTION ---

    chatSocket.onclose = function(e) {
      console.error('Chat socket closed unexpectedly');
    };

    document.getElementById('chat-message-input').focus();
    document.getElementById('chat-message-input').onkeyup = function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('chat-message-submit').click();
      }
    };

    // --- MODIFIED: Send button sends a 'new_message' command ---
    document.getElementById('chat-message-submit').onclick = function(e) {
      const messageInputDom = document.getElementById('chat-message-input');
      const message = messageInputDom.value.trim();
      if (message) {
        chatSocket.send(JSON.stringify({
          'command': 'new_message', // Specify command
          'message': message,
          'sender_id': userId,
          'sender_name': userName
        }));
        messageInputDom.value = '';
      }
    };

    // --- NEW: Event delegation for Edit/Delete buttons ---
    chatBox.addEventListener('click', function(e) {
      const target = e.target;

      // Handle EDIT click
      if (target.classList.contains('chat-action-edit')) {
        e.preventDefault();
        const messageId = target.dataset.id;
        const messageBubble = document.querySelector(`.message-bubble[data-message-id="${messageId}"]`);
        const contentDiv = messageBubble.querySelector('.message-content');
        const currentContent = contentDiv.innerText;

        const newContent = window.prompt("Edit your message:", currentContent);

        if (newContent && newContent.trim() !== "" && newContent !== currentContent) {
          chatSocket.send(JSON.stringify({
            'command': 'edit_message',
            'message_id': messageId,
            'new_content': newContent.trim()
          }));
        }
      }

      // Handle DELETE click
      if (target.classList.contains('chat-action-delete')) {
        e.preventDefault();
        const messageId = target.dataset.id;

        if (window.confirm("Are you sure you want to delete this message?")) {
          chatSocket.send(JSON.stringify({
            'command': 'delete_message',
            'message_id': messageId
          }));
        }
      }
    });

  });
</script>
{% endblock %}